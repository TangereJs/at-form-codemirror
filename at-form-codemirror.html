<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../code-mirror/code-mirror.html" />

<dom-module id="at-form-codemirror">
  <style>
    :host {
      display: block;
      position: relative;
    }
    
    #codeMirrorArea {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    #requiredValidationMessage {
      display: none;
    }
    
    #requiredValidationMessage[invalid] {
      display: block;
      position: relative;
    }
    
    .error {
      color: rgb(255, 0, 0);
      font-size: inherit;
      font: inherit;
    }
    
    .codeMirrorLabel {
      font-size: 14px;
      font-weight: bold;
      display: block;
      padding: 0 0 0.3em 0;
    }
    
    code-mirror {
      width: 100%;
      height: 100%;
    }
  </style>
  <template>
    <div id="labelArea">
      <label class="codeMirrorLabel">{{label}}</label>
    </div>

    <code-mirror id="codeMirror"></code-mirror>

    <div id="requiredValidationMessage" class="required">
      <p class="error">This field is required</p>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'at-form-codemirror',
    properties: {
      value: {
        type: String,
        value: '',
        notify: true,
        observer: 'valueChanged'
      },
      mode: {
        type: String,
        value: 'htmlmixed',
        observer: 'modeChanged'
      },
      theme: {
        type: String,
        value: 'xq-light',
        observer: 'themeChanged'
      },
      tabSize: {
        type: Number,
        value: 2,
        observer: 'tabSizeChanged'
      },
      noLineNumbers: {
        type: Boolean,
        value: false,
        observer: 'lineNumbersChanged'
      },
      required: {
        type: Boolean,
        value: false,
        observer: 'requiredChanged'
      },
      disabled: {
        type: Boolean,
        value: false,
        observer: 'disabledChanged'
      },
      label: {
        type: String,
        value: '',
      }
    },
    _cursor: undefined,
    _isReady: false,
    _cmInstace: undefined,
    attached: function () {
      var cmInstance = this._cmInstace = this.$.codeMirror.mirror;
      var self = this;
      cmInstance.on('change', function (codeMirror, changeObj) {
        self.requiredChanged();
        self.value = codeMirror.getValue();
      });

      this._isReady = true;

      if (!this.value) {
        // copy content from innerHtml/childNodes if no value was provided
        var tc = "";
        var c = Polymer.dom(this).childNodes;
        for (var i = 0; i < c.length; i++) {
          tc += c[i].textContent;
        }
        this.value = tc;
      }
    },
    refresh: function () {
      if (this._isReady) {
        this._cmInstace.refresh();
      }
    },
    valueChanged: function () {
      if (this._isReady) {
        // we remember the cursor because mirror.setValue() sets the cursor to (0, 0)
        this._cursor = this._cmInstace.getCursor();
        this._cmInstace.setValue(this.value);
        this.requiredChanged();
        // we restore the previous cursor position
        this._cmInstace.setCursor(this._cursor);
        this.updateInvalidAttr();
      }
    },
    modeChanged: function () {
      if (this._isReady) {
        this._cmInstace.setOption('mode', this.mode);
      }
    },
    themeChanged: function () {
      if (this._isReady) {
        this._cmInstace.setOption('theme', this.theme);
      }
    },
    tabSizeChanged: function () {
      if (this._isReady) {
        this._cmInstace.setOption('tabSize', this.tabSize);
      }
    },
    lineNumbersChanged: function () {
      if (this._isReady) {
        this._cmInstace.setOption('lineNumbers', this.lineNumbers);
      }
    },
    focus: function () {
      if (this._isReady) {
        this._cmInstace.focus();
      }
    },
    disabledChanged: function (oldValue, newValue) {
      if (this._isReady) {
        this._cmInstace.setOption('readOnly', this.disabled);
      }
    },
    requiredChanged: function (oldValue, newValue) {
      if (this._isReady) {

        this.updateInvalidAttr();
      }
    },
    updateInvalidAttr: function () {
      if (this.required && (this.value === undefined || this.value == '')) {
        this.$.requiredValidationMessage.setAttribute('invalid', true);
      } else {
        this.$.requiredValidationMessage.removeAttribute('invalid');
      }
    },
    autoGrow: function (input) {
      input.oninput = function () {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
        window.scrollTo(window.scrollLeft, (this.scrollTop + this.scrollHeight));
      };

      var inputEvent = document.createEvent('Event');
      inputEvent.initEvent('input', true, true);
      input.dispatchEvent(inputEvent);
    }
  });
</script>