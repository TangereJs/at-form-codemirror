<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../code-mirror/code-mirror.html" />
<link rel="import" href="../at-core-theme/at-core-theme.html">

<dom-module id="at-form-codemirror">
  <style>
    :host {
      display: block;
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    #codeMirrorArea {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    .error {
      color: rgb(255, 0, 0);
      font-size: inherit;
      font: inherit;
    }
    
    .codeMirrorLabel {
      font-size: 14px;
      font-weight: bold;
      display: block;
      padding: 0 0 0.3em 0;
    }
    
    #wrapper {
      height: 100%;
    }

  </style>
  <template>
    <div id="wrapper" class="field">
      <div id="labelArea">
        <label class="codeMirrorLabel">{{label}}</label>
      </div>

      <code-mirror id="codeMirror"></code-mirror>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'at-form-codemirror',
    properties: {
      value: {
        type: String,
        value: '',
        notify: true,
        observer: 'valueChanged'
      },
      mode: {
        type: String,
        value: 'htmlmixed',
        observer: 'modeChanged'
      },
      theme: {
        type: String,
        value: 'xq-light',
        observer: 'themeChanged'
      },
      tabSize: {
        type: Number,
        value: 2,
        observer: 'tabSizeChanged'
      },
      noLineNumbers: {
        type: Boolean,
        value: false,
        observer: 'noLineNumbersChanged'
      },
      required: {
        type: Boolean,
        value: false,
        observer: 'requiredChanged'
      },
      valid: {
        type: Boolean,
        value: true,
        readOnly: true,
        notify: true
      },
      disabled: {
        type: Boolean,
        value: false,
        observer: 'disabledChanged'
      },
      label: {
        type: String,
        value: '',
      }
    },
    _isReady: false,
    _scopeCssViaAttr: true,
    _cmInstance: undefined,
    ready: function () {
      var cmInstance = this._cmInstance = this.$.codeMirror;
      var self = this;
      cmInstance.addEventListener('value-changed', function () {
        self.value = this.value;
      });

      this._isReady = true;

      if (!this.value) {
        // copy content from innerHtml/childNodes if no value was provided
        var tc = "";
        var c = Polymer.dom(this).childNodes;
        for (var i = 0; i < c.length; i++) {
          tc += c[i].textContent;
        }
        this.value = tc;
      }

      this._updateValidState();
      this.disabledChanged(this.disabled, this.disabled);
    },
    attached: function () {
      this._cmInstance.value = this.value;
    },
    refresh: function () {
      if (this._isReady) {
        this._cmInstance.refresh();
      }
    },
    focus: function () {
      if (this._isReady) {
        this._cmInstance.focus();
      }
    },
    valueChanged: function () {
      if (this._isReady) {
        this._cmInstance.value = this.value;
        this._updateValidState();
      }
    },
    modeChanged: function () {
      if (this._isReady) {
        this._cmInstance.mode = this.mode;
      }
    },
    themeChanged: function () {
      if (this._isReady) {
        this._cmInstance.theme = this.theme;
      }
    },
    tabSizeChanged: function () {
      if (this._isReady) {
        this._cmInstance.tabSize = this.tabSize;
      }
    },
    noLineNumbersChanged: function () {
      if (this._isReady) {
        this._cmInstance.noLineNumbers = this.noLineNumbers;
      }
    },
    disabledChanged: function (newValue, oldValue) {
      if (this._isReady) {
        this._cmInstance.disabled = this.disabled;
        if (this.disabled) {
          this.toggleClass('error', false, this.$.wrapper);
        } else {
          this.toggleClass('error', !this.valid, this.$.wrapper);
        }
      }
    },
    requiredChanged: function (oldValue, newValue) {
      if (this._isReady) {
        this._updateValidState();
      }
    },
    _updateValidState: function () {
      var validValue = this.required ? this.value !== undefined && this.value !== '' : true;
      this._setValid(validValue);
    },
    validate: function () {
      this._updateValidState();
      this.toggleClass('error', !this.valid, this.$.wrapper);
      return this.valid;
    },
    autoGrow: function (input) {
      input.oninput = function () {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
        window.scrollTo(window.scrollLeft, (this.scrollTop + this.scrollHeight));
      };

      var inputEvent = document.createEvent('Event');
      inputEvent.initEvent('input', true, true);
      input.dispatchEvent(inputEvent);
    }
  });
</script>