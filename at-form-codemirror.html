<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-theme/at-theme.html">
<link rel="import" href="../at-i18n/at-i18n-behavior.html">
<link rel="import" href="../code-mirror/code-mirror.html">
<link rel="import" href="../at-form-behaviors/at-form-behaviors-validation.html">
<link rel="import" href="../iron-label/iron-label.html">

<dom-module id="at-form-codemirror">
  <template>
  <style include="at-form-common"></style>
  <style>
    :host * {
      box-sizing: border-box;
    }

    :host {
      @apply(--at-form-host);
    }

    #hint {
      min-height: 14px;
      margin-bottom: 8px;
    }

  </style>
    <div id="atContainer" class="at-container">
      <iron-label id="label" for="codeMirror">{{label}}</iron-label>
      <div id="contentContainer" class="at-content-container">
        <code-mirror id="codeMirror" max-lines={{maxLines}}></code-mirror>
      </div>
      <div id="hint"></div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'at-form-codemirror',
    behaviors: [Tangere.behaviors.i18n, Tangere.behaviors.formValidation],
    properties: {
      value: {
        type: String,
        value: '',
        notify: true,
        observer: 'valueChanged',
        xtype: "textarea",
        title: 'Value'
      },
      hideLabel: {
        type: Boolean,
        value: false,
        observer: 'hideLabelChanged',
        title: 'Do not show the label'
      },
      mode: {
        type: String,
        value: 'htmlmixed',
        observer: 'modeChanged',
        xtype: "enum",
        xvaluelist: "htmlmixed,javascript,css,markdown,sql,xml"
      },
      theme: {
        type: String,
        value: 'xq-light',
        observer: 'themeChanged',
        xtype: 'enum',
        xvaluelist: [
          { title: "Ambiance", value: "ambiance"},
          { title: "Blackboard", value: "blackboard"},
          { title: "Cobalt", value: "cobalt"},
          { title: "Eclipse", value: "eclipse"},
          { title: "Elegant", value: "elegant"},
          { title: "Erlang dark", value: "erlang-dark"},
          { title: "Lesser Dark", value: "lesser-dark"},
          { title: "Midnight", value: "midnight"},
          { title: "Monokai", value: "monokai"},
          { title: "Neat", value: "neat"},
          { title: "Night", value: "night"},
          { title: "Rubyblue", value: "rubyblue"},
          { title: "Solarized", value: "solarized"},
          { title: "Twilight", value: "twilight"},
          { title: "Vibrant Ink", value: "vibrant-ink"},
          { title: "XQ Dark", value: "xq-dark"},
          { title: "XQ Light", value: "xq-light"}
        ]
      },
      tabSize: {
        type: Number,
        value: 2,
        observer: 'tabSizeChanged'
      },
      noLineNumbers: {
        type: Boolean,
        value: false,
        observer: 'noLineNumbersChanged'
      },
      required: {
        type: Boolean,
        value: false,
        observer: 'requiredChanged',
        title: 'Input required'
      },
      disabled: {
        type: Boolean,
        value: false,
        observer: 'disabledChanged',
        title: 'Field value can not be changed'
      },
      label: {
        type: String,
        value: '',
        title: 'Label'
      },
      /**
       * Hides the element. When hidden nothing is displayed for the element
       * @property hide
       * @type Boolean
       * @default false
       */
      hide: {
        type: Boolean,
        value: false,
        observer: 'hideChanged',
        title: 'Field is invisible'
      },
      maxLines: {
        type: Number,
        value: 14,
        observer: 'maxLinesChanged'
      },
      maxChars: {
        type: Number,
        value: 0,
        observer: 'maxCharsChanged',
        title: 'Maximum number of characters'
      }
    },
    $meta: [{
      title: "Code",
      type: "string",
      xtype: "code"
    }, {
      title: "JSON code",
      type: "object",
      xtype: "json"
    }],
    _errorMessageTemplates: {
      maxCharsHint: "You can not enter more than {maxChars} characters."
    },
    _cmInstance: undefined,
    hideChanged: function (newValue, oldValue) {
      var atContainer = this.$.atContainer;
      this.toggleClass('hidden', newValue, atContainer);
      if (!newValue) {
        this.refresh();
        this.$.codeMirror.maxLinesChanged(this.maxLines, this.maxLines);
      }
      if (this._isReady) {
        this.validate();
      }
    },
    _getFocusableElement: function () {
      return this.$.codeMirror;
    },
    ready: function() {
      this._isReady = false;
      var cmInstance = this._cmInstance = this.$.codeMirror;
      var self = this;
      cmInstance.addEventListener('value-changed', function() {
        self.value = this.value;
      });

      this._isReady = true;

      if (!this.value) {
        // copy content from innerHtml/childNodes if no value was provided
        var tc = "";
        var c = Polymer.dom(this).childNodes;
        for (var i = 0; i < c.length; i++) {
          tc += c[i].textContent;
        }
        this.value = tc;
      }

      this._validationFunctions.push(this._validateMaxChars.bind(this));

      this.disabledChanged(this.disabled, this.disabled);
    },
    hideLabelChanged: function(newValue, oldValue) {
      this.toggleClass("hidden", newValue, this.$.label);
    },
    attached: function() {
      this._cmInstance.value = String(this.value);
    },
    refresh: function() {
      if (this._isReady) {
        this._cmInstance.refresh();
      }
    },
    focus: function() {
      if (this._isReady) {
        this._cmInstance.focus();
      }
    },
    valueChanged: function(newValue, oldValue) {
      if (this._isReady) {
        // *ij* [object SpeechRecognition]
        // well at-core-mic recognition property is of that type and it needs to be strigified so there you have it
        if (this._isObject(newValue) || this._isArray(newValue) || this._isSpeechRecognition(newValue)){
          newValue = JSON.stringify(newValue, null, ' ');
          this.value = newValue;
          return;
        }
        this._cmInstance.value = String(this.value);
        this.validate();
      }
    },
    modeChanged: function() {
      if (this._isReady) {
        this._cmInstance.mode = this.mode;
      }
    },
    themeChanged: function() {
      if (this._isReady) {
        this._cmInstance.theme = this.theme;
      }
    },
    tabSizeChanged: function() {
      if (this._isReady) {
        this._cmInstance.tabSize = this.tabSize;
      }
    },
    noLineNumbersChanged: function() {
      if (this._isReady) {
        this._cmInstance.noLineNumbers = this.noLineNumbers;
      }
    },
    disabledChanged: function(newValue, oldValue) {
      if (this._isReady) {
        this._cmInstance.disabled = this.disabled;

        var label = this.$.label;
        this.toggleClass('disabled', newValue, label);
        var contentContainer = this.$.contentContainer;
        this.toggleClass('disabled', newValue, contentContainer);

        this.validate();
      }
    },
    requiredChanged: function(oldValue, newValue) {
      if (this._isReady) {
        this.validate();
      }
    },
    maxLinesChanged: function (newValue, oldValue) {
      if (this._isReady) { }
    },
    maxCharsChanged: function (newValue, oldValue) {
      if (this._isReady) {
        this.validate();
      }
    },
    _validateMaxChars: function (value) {
      var valid = true;

      try {
        var maxChars = parseInt(this.maxChars);
        if (maxChars > 0) {
          var charCount = value.length;
          valid = (maxChars + 1) > charCount;

          this._errorMessage = this._errorMessageTemplates.maxCharsHint.replace("{maxChars}", this.maxChars);
        }
      } catch (e) {
        console.log(e);
      }

      return valid;
    },
    _updateUIValidState: function(isValid) {
      var label = this.$.label;
      this.toggleClass('error', !isValid, label);
      var contentContainer = this.$.contentContainer;
      this.toggleClass('error', !isValid, contentContainer);
      var atContainer = this.$.atContainer;
      var codeMirrorCode = atContainer.getElementsByClassName('CodeMirror-lines')[0];
      this.toggleClass('error', !isValid, codeMirrorCode);
      var hint = this.$.hint;
      this.toggleClass('error', !isValid, hint);
    },
    _isObject: function (obj) {
      return Object.prototype.toString.call(obj) === "[object Object]";
    },
    _isSpeechRecognition: function (obj) {
      return Object.prototype.toString.call(obj) === "[object SpeechRecognition]";
    },
    _isArray: function (obj) {
      return Object.prototype.toString.call(obj) === "[object Array]";
    }
  });
</script>
