<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../code-mirror/codemirror-import.html" />

<!-- mode name: text/html or htmlmixed  -->
<script src="../code-mirror/codemirror-4.0/mode/htmlmixed/htmlmixed.js"></script>
<!-- mode name: text/css -->
<script src="../code-mirror/codemirror-4.0/mode/css/css.js"></script>
<!-- mode names: javascript, application/json  -->
<script src="../code-mirror/codemirror-4.0/mode/javascript/javascript.js"></script>
<!-- mode name: sql -->
<script src="../code-mirror/codemirror-4.0/mode/sql/sql.js"></script>
<!-- mode name: markdown -->
<script src="../code-mirror/codemirror-4.0/mode/markdown/markdown.js"></script>
<!-- mode name: xml -->
<script src="../code-mirror/codemirror-4.0/mode/xml/xml.js"></script>

<dom-module id="at-form-codemirror">
  <template>
    <link rel="stylesheet" href="../code-mirror/codemirror-4.0/lib/codemirror.css">
    <link href="../code-mirror/codemirror-4.0/theme/ambiance.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/ambiance-mobile.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/blackboard.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/cobalt.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/eclipse.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/elegant.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/erlang-dark.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/lesser-dark.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/midnight.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/monokai.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/neat.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/night.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/rubyblue.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/solarized.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/twilight.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/vibrant-ink.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/xq-dark.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/theme/xq-light.css" rel="stylesheet">
    <link href="../code-mirror/codemirror-4.0/addon/fold/foldgutter.css" rel="stylesheet">
    <style>
      :host {
        display: block;
        position: relative;
      }
      
      .CodeMirror {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
      }
      
      #codeMirrorArea {
        position: relative;
        width: 100%;
        height: 100%;
      }
      
      #requiredValidationMessage {
        display: none;
      }
      
      #requiredValidationMessage[invalid] {
        display: block;
        position: relative;
      }
      
      .error {
        color: rgb(255, 0, 0);
        font-size: inherit;
        font: inherit;
      }
      
      .codeMirrorLabel {
        font-size: 14px;
        font-weight: bold;
        display: block;
        padding: 0 0 0.3em 0;
      }
    </style>
    <div id="labelArea">
      <label class="codeMirrorLabel">{{label}}</label>
    </div>
    <div id="codeMirrorArea"></div>
    <div id="requiredValidationMessage" class="required">
      <p class="error">This field is required</p>
    </div>
  </template>

</dom-module>

<script>
  Polymer({
    is: 'at-form-codemirror',
    properties: {
      value: {
        type: String,
        value: '',
        notify: true,
        observer: 'valueChanged'
      },
      // available modes are
      // htmlmixed, text/css, javascript, application/json, sql, xml
      mode: {
        type: String,
        value: 'htmlmixed',
        observer: 'modeChanged'
      },
      theme: {
        type: String,
        value: 'xq-light',
        observer: 'themeChanged'
      },
      tabSize: {
        type: Number,
        value: 2,
        observer: 'tabSizeChanged'
      },
      noLineNumbers: {
        type: Boolean,
        value: false,
        observer: 'lineNumbersChanged'
      },
      required: {
        type: Boolean,
        value: false,
        observer: 'requiredChanged'
      },
      disabled: {
        type: Boolean,
        value: false,
        observer: 'disabledChanged'
      },
      label: {
        type: String,
        value: '',
      }
    },
    _cursor: undefined,
    _isReady: false,
    ready: function () {
      if (!this.value) {
        this.value = this.textContent;
      }
      this.mirror = CodeMirror(this.$.codeMirrorArea, {
        value: this.value || this.textContent,
        mode: this.mode,
        theme: this.theme,
        tabSize: this.tabSize,
        lineNumbers: !this.noLineNumbers,
        foldGutter: true,
        readOnly: this.disabled,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
      });
      var self = this;
      this.mirror.on('change', function (codeMirror, changeObj) {
        self.requiredChanged();
        self.value = codeMirror.getValue();
      });

      this._isReady = true;
    },
    refresh: function () {
      if (this._isReady) {
        this.mirror.refresh();
      }
    },
    valueChanged: function () {
      if (this._isReady) {
        // we remember the cursor because mirror.setValue() sets the cursor to (0, 0)
        this._cursor = this.mirror.getCursor();
        this.mirror.setValue(this.value);
        this.requiredChanged();
        // we restore the previous cursor position
        this.mirror.setCursor(this._cursor);
        this.updateInvalidAttr();
      }
    },
    modeChanged: function () {
      if (this._isReady) {
        this.mirror.setOption('mode', this.mode);
      }
    },
    themeChanged: function () {
      if (this._isReady) {
        this.mirror.setOption('theme', this.theme);
      }
    },
    tabSizeChanged: function () {
      if (this._isReady) {
        this.mirror.setOption('tabSize', this.tabSize);
      }
    },
    lineNumbersChanged: function () {
      if (this._isReady) {
        this.mirror.setOption('lineNumbers', this.lineNumbers);
      }
    },
    focus: function () {
      if (this._isReady) {
        this.mirror.focus();
      }
    },
    disabledChanged: function (oldValue, newValue) {
      if (this._isReady) {
        this.mirror.setOption('readOnly', this.disabled);
      }
    },
    requiredChanged: function (oldValue, newValue) {
      if (this._isReady) {

        this.updateInvalidAttr();
      }
    },
    updateInvalidAttr: function () {
      if (this.required && (this.value === undefined || this.value == '')) {
        this.$.requiredValidationMessage.setAttribute('invalid', true);
      } else {
        this.$.requiredValidationMessage.removeAttribute('invalid');
      }
    },
    autoGrow: function (input) {
      input.oninput = function () {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
        window.scrollTo(window.scrollLeft, (this.scrollTop + this.scrollHeight));
      };

      var inputEvent = document.createEvent('Event');
      inputEvent.initEvent('input', true, true);
      input.dispatchEvent(inputEvent);
    }
  });
</script>

<!-- Recycle this code should any of these modes should be needed -->
<!--<script src="../code-mirror/codemirror-4.0/mode/apl/apl.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/asterisk/asterisk.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/clike/clike.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/clojure/clojure.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/cobol/cobol.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/coffeescript/coffeescript.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/commonlisp/commonlisp.js"></script>-->
<!--<script src="../code-mirror/codemirror-4.0/mode/d/d.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/diff/diff.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/dtd/dtd.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/ecl/ecl.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/eiffel/eiffel.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/erlang/erlang.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/fortran/fortran.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/gas/gas.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/gfm/gfm.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/gherkin/gherkin.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/go/go.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/groovy/groovy.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/haml/haml.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/haskell/haskell.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/haxe/haxe.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/htmlembedded/htmlembedded.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/http/http.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/jade/jade.js"></script>

<script src="../code-mirror/codemirror-4.0/mode/jinja2/jinja2.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/julia/julia.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/livescript/livescript.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/lua/lua.js"></script>

<script src="../code-mirror/codemirror-4.0/mode/mirc/mirc.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/mllike/mllike.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/nginx/nginx.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/ntriples/ntriples.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/octave/octave.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/pascal/pascal.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/pegjs/pegjs.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/perl/perl.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/php/php.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/pig/pig.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/properties/properties.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/puppet/puppet.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/python/python.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/q/q.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/r/r.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/rpm/rpm.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/rst/rst.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/ruby/ruby.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/rust/rust.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/sass/sass.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/scheme/scheme.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/shell/shell.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/sieve/sieve.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/smalltalk/smalltalk.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/smarty/smarty.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/smartymixed/smartymixed.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/solr/solr.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/sparql/sparql.js"></script>

<script src="../code-mirror/codemirror-4.0/mode/stex/stex.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/tcl/tcl.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/tiddlywiki/tiddlywiki.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/tiki/tiki.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/toml/toml.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/turtle/turtle.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/vb/vb.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/vbscript/vbscript.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/velocity/velocity.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/verilog/verilog.js"></script>

<script src="../code-mirror/codemirror-4.0/mode/xquery/xquery.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/yaml/yaml.js"></script>
<script src="../code-mirror/codemirror-4.0/mode/z80/z80.js"></script>-->